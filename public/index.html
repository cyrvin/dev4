<!DOCTYPE html>
<html>
<head>
  <link href="//netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css" rel="stylesheet">
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js"></script>
  <script src="https://d3f5pyioow99x0.cloudfront.net/0.8/hull.api.js"></script>
  <script type='text/javascript'>

/*_____________________________________________________________________________

                              HULL AUTHENTIFICATION
_____________________________________________________________________________*/

Hull.init({
  appId : "53a18b3764d35b45710003ee",
  orgUrl: "https://73215df1.hullapp.io"
}, function(hull) {
  console.log("Hull is initialized for app", hull.config());
});

// On auth success
var onAuthComplete = function(user) {
  console.log('Hello ' + user.name + ', on lance le fetch des connections !');
  fetchConnections();
};

// On auth failure
var onAuthError = function(error) {
  var message, reason  = error && error.reason;
  switch(reason) {
    case 'email_taken':
    message = error.email + ' is already taken by User with id: ' + error.user_id;
    break;
    case 'auth_failed':
    message = 'User did not fully authorize or provider app is not well configured';
    break;
    case 'window_closed':
    message = 'User closed the window';
    break;
    default:
    message = 'Oops... Something went wrong on our side...';
  }
  console.log("Error: ", message)
};

function linkedInConnect() {
  Hull.login('linkedin').then(onAuthComplete, onAuthError);
  deleteButton();
};

function deleteButton() {
  var div = document.getElementById("linkedInButton");
  div.parentNode.removeChild(div);
}

/*_____________________________________________________________________________

                              LINKEDIN API DATA FETCH
_____________________________________________________________________________*/

var connections = [];
var companies = [];
var output = {};
var companyIds = [];
var companyIdsOK = [];
var companyRawData = [];

function fetchConnections() {
  Hull.api({
    provider:'linkedin',
    //path:'/people/~/connections:(id,positions)'
    //path:'/people/~/connections:(id,first-name,last-name,industry,location,public-profile-url)'
    path:'/people/~/connections:(id,positions:(company:(id)))'
  },function(result){
    output = result;
    console.log('LinkdeIn API : fetch des connections, voilà la bête : ', output);
    listCompanyIds();
  });
}

function listCompanyIds() {

  console.log('Début listCompanyIds()');

  for (var i in output.values) {
    var connection = output.values[i];
    if (typeof(connection.positions) === 'undefined') continue;
    if (typeof(connection.positions.values) === 'undefined') continue;

    for (var j in connection.positions.values) {
      var position = connection.positions.values[j];
      if (typeof(position.company) === 'undefined') continue;
      if (typeof(position.company.id) === 'undefined') continue;
      companyIds.push(position.company.id);
    }
  }
  console.log('companyIds', companyIds);
}

function fetchSkillsInPublicProfile() {
  var service_url = '../connection/?puburl=https://www.linkedin.com/in/cyrillevincey';
  // var params = {
  //   'puburl': 'https://www.linkedin.com/in/cyrillevincey',
  // };


  $.ajax({
	  dataType: "json",
	  url: service_url,
	  success: function(response, body){
	  	console.log("body: ", body);
	  	console.log("response: ", response);
	  },
	  error: function(error){
	  	console.log("error: ", error);
	  }
	});

};

</script>

</head>
<body>
  <button id="linkedInButton" onclick="linkedInConnect();">LinkedIn Connect</button>
</body>
</html>